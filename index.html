<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Saving the world with Umbraco & GraphQL</title>

		<link rel="stylesheet" href="https://use.typekit.net/gxl0wpb.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/custom.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/atom-one-dark.css">
		<!-- <link href="lib/css/prism.css" rel="stylesheet" /> -->

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h1>Umbraco & GraphQL</h1>
					<p>
						Saving the world
					</p>
					<aside class="notes">
						<h3>Why am I here?</h3>
						<p>Extending the community Umbraco GraphQL package with custom data structures</p>
						<p>The data set that we will be looking at for the demo is carbon emission related and I will explain why in a bit</p>
					</aside>
				</section>

				<section>
					<div class="flex center space">
						<img class="laura" src="/images/laura2.png" />
						<div class="">
							<h2>Laura Weatherhead</h2>
							<p><a href="https://twitter.com/lssweatherhead">@lssweatherhead</a></p>
							<p>Full-Stack Developer @ Spun</p>
							<p></p>
						</div>
						<img class="laura" src="/images/laura3.png" />
					</div>
					<p class="runline">
						Problem&nbsp;solver. Amateur&nbsp;acrobat. Adopted&nbsp;Scot. Pedant. Arachnophobe. Chocaholic.
					</p>

					<aside class="notes">
						<h3>Who am I?</h3>
						<p>I'm Laura - developer etc</p>
						<p>Climate Change: the Facts - David Attenborough</p>
						<p>How to make informed decisions?</p>
					</aside>
				</section>

				<section>
					<h2>What is GraphQL and why would we want to use it?</h2>
					<ul>
						<li>It's a data graph</li>
						<li>Shifts the parameter requirements from the server-side code to the front-end</li>
						<li>Allows easy access to filtering, sorting, paging etc</li>
						<li>Pete Duncanson, Offroadcode & Rasmus Pedersen have produced the awesome Umbraco GraphQL community package</li>
					</ul>

					<aside class="notes" data-markdown>
						* Pete memorably offers the comparison that GraphQL is to traditional API calls what a jukebox is to mixtapes
						* WHAT is GraphQL: 2 things:
							* a query l a n g u a g e for requesting data from a server or API
							* and a r u n t i m e for fulfilling those queries
						* How does it work & why should we use it?
							* firstly you d e s c r i b e the shape of your content - create the graph!
							* you ask only for what you need and get only what you need back
							* get many resources in the same request
						* Allows the FE dev to define what parameters are required and update/remove them in the FE code without needed to re-write API calls or do a full deployment
						For the example website that has been created, I have used the community Our.Umbraco.GraphQL as a base: all credits go to Rasmus J Pederson & the OffRoadCode crew
					</aside>
				</section>

				<section>
					<h2>Carbon Footprinting</h2>
					<img src="/images/footprinting.PNG"/>
					<aside class="notes" data-markdown>
						* The usecase is a project that has large amounts of structured data
						* We will be looking at using Umbraco (v7) and GraphQL together to map and resolve custom PetaPoco data from a bespoke dashboard and surfacing it as part of the exposed GraphQL API.
						* The structure that we have here is fairly simple for the sake of demonstration. We have:
						- An `ItemType` category e.g. "Food"
						  - Which has one or more `Item` e.g. "1 x mug of tea or coffee"
							- Which has one or more `Variant` e.g. "1 x mug of tea or coffee with milk, boiling only what you need"
						* Each `Variant` is tagged with an approximate cost in **carbon dioxide equivalent (CO<sub>2</sub>e)** which is essentially a shorthand for expressing all of the greenhouse gases that an activity or item emits in terms of the equivalent amount of carbon dioxide. This loses some accuracy but makes it slightly easier to make comparisons!
					</aside>
				</section>

				<section class="code">
					<h3>Classes</h3>
					<pre><code class="hljs" data-trim contenteditable>
public class ItemType
{
	public int Id { get; set; }

	public string Name { get; set; }
}

public class Item
{
	public int Id { get; set; }

	public string ItemName { get; set; }

	public double MinCarbonDioxideEquivalent { get; set; }

	public double MaxCarbonDioxideEquivalent { get; set; }
}

public class Variant
{
	public int Id { get; set; }

	public string VariantName { get; set; }

	public double CarbonDioxideEquivalent { get; set; }
}</code></pre>
					<aside class="notes">
						These are the POCOs we have on the C# side
					</aside>
				</section>

				<section>
					<h3>What's the plan?</h3>
					<ol>
						<li>Construct data shapes</li>
						<li>Construct querying functionality</li>
						<li>Return data from the application</li>
					</ol>
					<aside data-markdown class="notes">
						This is the data that we want to able to access through GraphQL, so now we need to look at the steps that will allow that to happen.

						1. GraphQL essentially works using a data "shape", so the first step is to set up graph types that will inform the application what our data structure looks like
						2. The second paradigm of GraphQL is the query capacity, so we also need to tell the application what queries can be completed and how these queries should work
						3. Finally, we will need to extend on the work completed by Rasmus and Offroadcode to surface our structure alongside the existing Umbraco content query structure
						
						Let's explore these in more detail...
					</aside>
				</section>

				<section class="code">
					<h3>1. Add new graph types and set our data shape</h3>
					<pre><code class="csharp" data-trim contenteditable data-noescape>
public class CarbonFootprintCategoryGraphType : ObjectGraphType&lt;ItemType&gt;
{
	public CarbonFootprintCategoryGraphType()
	{
		Name = "CarbonFootprintCategory";

		Field&lt;NonNullGraphType&lt;IntGraphType&gt;(
			"id",
			resolve: context => context.Source.Id
		);
		Field&lt;NonNullGraphType&lt;StringGraphType&gt;(
			"name",
			resolve: context => context.Source.Name
		);
		Field&lt;NonNullGraphType&lt;ListGraphType&lt;CarbonFootprintItemGraphType&gt;&gt;&gt;(
			"items",
			resolve: context => DatabaseContext.GetItemsByCategoryId(context.Source.Id)
		);
	}
}</code></pre>

					<aside class="notes" data-markdown>
						So there are a few things going on here:
						- We are inheriting an `ObjectGraphType` of our data class and this is used as the `context.Source` when mapping from the properties to the built in GraphQL [Schema Types](https://graphql-dotnet.github.io/docs/getting-started/schema-types)
						- We are declaring an "items" property that returns a `ListGraphType` (a list) of `CarbonFootprintItemGraphType` objects. This is the next graph type that we will need to define.
					</aside>
				</section>

				<section class="code">
<pre><code class="csharp" data-trim contenteditable data-noescape>
public class CarbonFootprintItemGraphType: ObjectGraphType&lt;Item&gt;
{
	public CarbonFootprintItemGraphType()
	{
		Name = "CarbonFootprintItem";
		Field&lt;NonNullGraphType&lt;IntGraphType&gt;&gt;(
			"id",
			resolve: context => context.Source.Id
		);
		Field&lt;NonNullGraphType&lt;StringGraphType&gt;&gt;(
			"name",
			resolve: context => context.Source.ItemName
		);
		Field&lt;NonNullGraphType&lt;CarbonFootprintCategoryGraphType&gt;&gt;(
			"category",
			resolve: context => DatabaseContext.GetCategoryById(context.Source.ItemType)
		);

		Field&lt;NonNullGraphType&lt;FloatGraphType&gt;&gt;(
			"minCarbonDioxideEquivalentInGrams",
			resolve: context => context.Source.MinCarbonDioxideEquivalent
		);

		Field&lt;FloatGraphType&gt;(
			"maxCarbonDioxideEquivalentInGrams",
			resolve: context => context.Source.MaxCarbonDioxideEquivalent
		);

		Field&lt;NonNullGraphType&lt;ListGraphType&lt;CarbonFootprintVariantGraphType&gt;&gt;&gt;(
			"variants",
			resolve: context => DatabaseContext.GetVariantsByItemId(context.Source.Id)
		);
	}
}</code></pre>
					<aside class="notes" data-markdown>
						Again this is just to illustrate the relationships between the data
					</aside>
				</section>
				
				<section class="code">
					<h3>2. Add new query structures</h3>
<pre><code class="csharp" data-trim contenteditable data-noescape>
public class CarbonFootprintQueryGraphType : ObjectGraphType
{
	public CarbonFootprintQueryGraphType(IEnumerable&lt;IGraphType> carbonFootprintTypes)
	{
		Name = "CarbonFootprintQuery";

		Field&lt;NonNullGraphType&lt;CarbonFootprintCategoryGraphType>>()
			.Name("byId")
			.Argument&lt;NonNullGraphType<IdGraphType>>("id", "The category id")
			.Resolve(context =>
			{
				var userContext = (UmbracoGraphQLContext)context.UserContext;
				var id = context.GetArgument&lt;int>("id");

				return userContext.DatabaseContext.GetCategoryById(id);
			});

		Field&lt;NonNullGraphType&lt;CarbonFootprintCategoryGraphType>>()
			.Name("byCategoryName")
			.Argument&lt;NonNullGraphType<StringGraphType>>("category", "The category name")
			.Resolve(context =>
			{
				var userContext = (UmbracoGraphQLContext)context.UserContext;
				var name = context.GetArgument&lt;string>("category");

				return userContext.DatabaseContext.GetCategoryByName(name);
			});
	}
}</code></pre>
					<aside class="notes" data-markdown>
						Now that we have our graph shapes, we need to tell GraphQL how we want to access this data. As an example we are going to expose two query types: 
						- byId which gets an ItemType category by its ID
						- byCategoryName which retrieves an ItemType category by name.
					</aside>
				</section>

				<section class="code">
					<h3>Umbraco Query</h3>
<pre><code class="csharp" data-trim contenteditable data-noescape>
public class UmbracoQuery : ObjectGraphType
{
	public UmbracoQuery(IEnumerable&lt;IGraphType> documentTypes, IEnumerable&lt;IGraphType> carbonFootprintingData)
	{
		Field&lt;PublishedContentQueryGraphType>()
			.Name("content")
			.Resolve(context => context.ReturnType)
			.Type(new NonNullGraphType(new PublishedContentQueryGraphType(documentTypes)));

		<mark>Field&lt;CarbonFootprintQueryGraphType>()</mark>
			<mark>.Name("carbonFootprintItems")</mark>
			<mark>.Resolve(context =&gt; context.ReturnType)</mark>
			<mark>.Type(new NonNullGraphType(new CarbonFootprintQueryGraphType(carbonFootprintingData)));</mark>
	}
}</code></pre>

					<aside class="notes" data-markdown>
						Extending the UmbracoQuery object to surface our custom data alongside the umbraco content
					</aside>
				</section>

				<section class="code">
					<h3>GraphQL query structure</h3>
<pre><code class="csharp" data-trim contenteditable data-noescape>
{
	carbonFootprintItems {
		byCategoryName(category: "food") {
			name
			items {
				name
				variants {
					name
					carbonDioxideEquivalentInGrams
				}
			}
		}
	}
}</code></pre>

					<aside class="notes" data-markdown>
						This data "shape" allows us to make queries that return this data for category type "Food"
					</aside>
				</section>

				<section class="code">
					<h3>3. Extend existing schema</h3>
<pre><code class="csharp" data-trim contenteditable data-noescape>
public class UmbracoSchema : global::GraphQL.Types.Schema
{
	public UmbracoSchema(
		IContentTypeService contentTypeService, IMemberTypeService memberTypeService,
		DatabaseContext dbContext, GraphQLServerOptions options)
	{
		// These are the Umbraco content schema graph types
		var documentTypes = CreateGraphTypes(contentTypeService.GetAllContentTypes(), PublishedItemType.Content).ToList();
		var mediaTypes = CreateGraphTypes(contentTypeService.GetAllMediaTypes(), PublishedItemType.Media).ToList();
		RegisterTypes(documentTypes.ToArray());
		RegisterTypes(mediaTypes.ToArray());

		// Custom data schema graph types!
		<mark>var carbonFootprintTypes = new List&lt;IGraphType&gt;();</mark>
		<mark>var categories = dbContext.GetAllCategories();</mark>

		<mark>foreach (var category in categories)</mark>
		<mark>{</mark>
			<mark>carbonFootprintTypes.Add(new CarbonFootprintGraphTypeMap(dbContext, category));</mark>
		<mark>}</mark>

		// Register our graph types with GraphQL
		<mark>RegisterTypes(carbonFootprintTypes.ToArray());</mark>

		Query = new UmbracoQuery(documentTypes, carbonFootprintTypes);
	}
}</code></pre>
					<aside class="notes" data-markdown>
						We are looping through all of our data categories and using them to create the IEnumerable&lt;IGraphType&gt; carbonFootprintingData argument
					</aside>
				</section>

				<section>
					<h3>Sample GQL query</h3>
<pre><code data-trim contenteditable data-noescape>{
	carbonFootprintItems {
		byCategoryName(category: "activities") {
			name
			items {
				name
				maxCarbonDioxideEquivalentInGrams
				variants {
					name
					carbonDioxideEquivalentInGrams
				}
			}
		}
	}
}</code></pre>
	<aside class="notes" data-markdown>
		So if we were to run this sample query now we should get a set of results associated with the Activities category
	</aside>
				</section>

				<section class="code">
	<pre><code>
{
  "data": {
    "carbonFootprintItems": {
      "byCategoryName": {
        "name": "Activities",
        "items":
        [
          {
            "name": "Spending £1",
            "maxCarbonDioxideEquivalentInGrams": 10000,
            "variants":
            [
              {
                "name": "Spending £1 on a well-executed rainforest preservation project",
                "carbonDioxideEquivalentInGrams": -330000
              },
              {
                "name": "Spending £1 on solar panels",
                "carbonDioxideEquivalentInGrams": -3000
              },
              {
                "name": "Spending £1 on financial, legal or professional advice",
				"carbonDioxideEquivalentInGrams": 160
              },
              {
                "name": "Spending £1 on flights",
				"carbonDioxideEquivalentInGrams": 4600
              },
              {
                "name": "Spending £1 on budget flights",
                "carbonDioxideEquivalentInGrams": 10000
              }
            ]
          }
        ]
      }
    }
  }
}</code></pre>
				</section>

				<section data-background="#9e1b3d">
					<h1 class="invert">Our Umbraco GraphQL for V8</h1>

					<aside class="notes" data-markdown>
						Soon to be released
						* swaps out graphiql for the GraphQL playground
						* bundles sample custom data structures WITH sorting, ordering
						* cultures as a query variable
					</aside>
				</section>

				<section>
					<img src="/images/badbananas.PNG" />
				</section>

				<section>
					<h1>Thank you!</h1>
					<ul>
						<li><a href="https://github.com/rasmusjp/umbraco-graphql">Our Umbraco GraphQL (V7)</a></li>
						<li><a href="https://github.com/lssweatherhead/umbraco-graphql/tree/BLG-2-Custom-Data-Section">Demo branch</a></li>
						<li><a href="https://skrift.io/articles/archive/saving-the-world-with-umbraco-and-graphql/">September Skrift Article</a></li>
						<li><a href="https://graphql-dotnet.github.io/docs/getting-started/introduction/">Getting started with GraphQL .NET</a></li>
					</ul>
					<h3 style="color:deepskyblue; margin-top: 20px;">@lssweatherhead</h3>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
					// { src: 'plugins/prism/prism.js'}
			
				]
			});
		</script>

		<style type="text/css">
			/* 1. Style header/footer <div> so they are positioned as desired. */
			#header-left {
				position: absolute;
				top: 0%;
				left: 0%;
			}
			#header-left .logo {
				padding: 20px;
				display: inline-flex;
			}
			#header-left .logo .icon {
				max-height: 70px;
				align-self: center;
			}
			#header-left .logo .company {
				max-height: 80px;
				align-self: center;
			}
		</style>

		<!-- 2. Create hidden header/footer <div> -->
		<div id="hidden" style="display:none;">
			<div id="header">
				<div id="header-left">
					<div class="logo">
						<img class="icon" alt="Icon" src="/images/logo.png" />
					</div>
				</div>
			</div>
		</div>

		<script src="lib/js/jquery-3.4.1.min.js"></script>
		<script type="text/javascript">
			// 3. On Reveal.js ready event, copy header/footer <div> into each `.slide-background` <div>
			var header = $('#header').html();
			if ( window.location.search.match( /print-pdf/gi ) ) {
				Reveal.addEventListener( 'ready', function( event ) {
					$('.slide-background').append(header);
				});
			}
			else {
				$('div.reveal').append(header);
		}
		</script>
	</body>
</html>
